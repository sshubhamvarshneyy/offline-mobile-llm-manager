# P0 E2E: Model Unload
# Tests unloading a currently loaded model
#
# Precondition: Model must be loaded
# Test: Open picker → Unload → Verify unloaded
# Postcondition: No model loaded, setup card visible

appId: ai.offgridmobile
name: "P0: Model Unload"
tags:
  - p0
  - model-unload
---

# ==============================
# Launch app
# ==============================
- evalScript: "${console.log('UNLOAD - Launch')}"
- launchApp

- extendedWaitUntil:
    notVisible:
      id: "app-loading"
    timeout: 30000
- evalScript: "${console.log('UNLOAD - App ready')}"

# ==============================
# Skip onboarding if needed
# ==============================
- runFlow:
    when:
      visible:
        text: "Welcome to Off Grid"
    commands:
      - evalScript: "${console.log('UNLOAD - Skip onboarding')}"
      - tapOn:
          text: "Skip"
      - extendedWaitUntil:
          visible:
            text: "Skip for Now"
          timeout: 30000
      - tapOn:
          text: "Skip for Now"

- runFlow:
    when:
      visible:
        text: "Download Your First Model"
    commands:
      - evalScript: "${console.log('UNLOAD - Skip prompt')}"
      - tapOn:
          text: "Skip for Now"

# ==============================
# Wait for home screen
# ==============================
- extendedWaitUntil:
    visible:
      id: "home-screen"
    timeout: 15000
- evalScript: "${console.log('UNLOAD - On home')}"
- takeScreenshot: 01-home

# ==============================
# Ensure a model is loaded (precondition)
# ==============================
- runFlow:
    when:
      visible:
        id: "setup-card"
    commands:
      # No model loaded, run setup to load one
      - evalScript: "${console.log('UNLOAD - Load model first')}"
      - runFlow: 00-setup-model.yaml

# Verify model is loaded
- assertVisible:
    id: "new-chat-button"
- takeScreenshot: 02-model-loaded

# ==============================
# Test: Unload the model
# ==============================
- evalScript: "${console.log('UNLOAD - Open picker')}"
- tapOn:
    text: "Text"

- extendedWaitUntil:
    visible:
      text: "Text Models"
    timeout: 5000
- takeScreenshot: 03-picker

# Tap unload button
- evalScript: "${console.log('UNLOAD - Tap unload')}"
- tapOn:
    text: "Unload current model"
- takeScreenshot: 04-unloading

# ==============================
# Verify model unloaded
# ==============================
- evalScript: "${console.log('UNLOAD - Verify unloaded')}"
- extendedWaitUntil:
    visible:
      id: "setup-card"
    timeout: 10000

- assertVisible:
    id: "setup-card"
- assertNotVisible:
    id: "new-chat-button"

- evalScript: "${console.log('UNLOAD - PASSED')}"
- takeScreenshot: 99-complete
