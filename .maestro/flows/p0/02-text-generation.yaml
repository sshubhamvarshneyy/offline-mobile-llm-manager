# P0 E2E: Text Generation Flow
# Tests the complete text generation cycle
# Prerequisites: Text model must be loaded

appId: ai.offgridmobile
name: "P0: Text Generation"
tags:
  - p0
  - generation
  - text
---

- launchApp

# Wait for app initialization
- extendedWaitUntil:
    notVisible:
      id: "app-loading"
    timeout: 30000

# Handle onboarding if shown
- runFlow:
    when:
      visible:
        text: "Welcome to Off Grid"
    commands:
      - tapOn:
          text: "Skip"
      - extendedWaitUntil:
          visible:
            text: "Skip for Now"
          timeout: 30000
      - tapOn:
          text: "Skip for Now"

# Handle download prompt if shown
- runFlow:
    when:
      visible:
        text: "Download Your First Model"
    commands:
      - tapOn:
          text: "Skip for Now"

# Wait for home screen
- extendedWaitUntil:
    visible:
      id: "home-screen"
    timeout: 15000

# Ensure model is loaded (run setup if needed)
- runFlow:
    when:
      visible:
        id: "setup-card"
    commands:
      - runFlow: 00-setup-model.yaml

# Wait for new-chat-button (model must be loaded)
- extendedWaitUntil:
    visible:
      id: "new-chat-button"
    timeout: 5000

# Navigate to chat screen
- tapOn:
    id: "new-chat-button"

# Wait for chat screen
- extendedWaitUntil:
    visible:
      id: "chat-screen"
    timeout: 10000

# Type a test message
- tapOn:
    id: "chat-input"
- inputText: "Hello, respond with one word: OK"

# Dismiss keyboard so send-button testID can be found
- hideKeyboard

# Send the message
- tapOn:
    id: "send-button"

# Wait for response (assistant message appears)
- extendedWaitUntil:
    visible:
      id: "assistant-message"
    timeout: 60000

# Verify input is ready for next message
- assertVisible:
    id: "chat-input"
