# P0 E2E: Setup - Ensure a text model is loaded and ready for chat
# This MUST run before all other tests
#
# Strategy: Simple and deterministic
# 1. Handle onboarding
# 2. If new-chat-button visible -> done
# 3. Otherwise navigate to Models tab directly and download if needed
# 4. Then select the model from picker

appId: ai.offgridmobile
name: "P0: Setup Test Model"
tags:
  - p0
  - setup
---

# ==============================
# Launch app
# ==============================
- evalScript: "${console.log('SETUP - Launch')}"
- launchApp

- extendedWaitUntil:
    notVisible:
      id: "app-loading"
    timeout: 30000
- evalScript: "${console.log('SETUP - App ready')}"
- takeScreenshot: 01-launch

# ==============================
# Handle Onboarding
# ==============================
- runFlow:
    when:
      visible:
        text: "Welcome to Off Grid"
    commands:
      - evalScript: "${console.log('SETUP - Skip onboarding')}"
      - tapOn:
          text: "Skip"
      - extendedWaitUntil:
          visible:
            text: "Skip for Now"
          timeout: 30000
      - tapOn:
          text: "Skip for Now"

# ==============================
# Handle Model Download Prompt
# ==============================
- runFlow:
    when:
      visible:
        text: "Download Your First Model"
    commands:
      - evalScript: "${console.log('SETUP - Skip download prompt')}"
      - tapOn:
          text: "Skip for Now"

# ==============================
# Wait for Home
# ==============================
- extendedWaitUntil:
    visible:
      id: "home-screen"
    timeout: 15000
- evalScript: "${console.log('SETUP - On home')}"
- takeScreenshot: 02-home

# ==============================
# Check if model already loaded (early exit)
# ==============================
- runFlow:
    when:
      visible:
        id: "new-chat-button"
    commands:
      - evalScript: "${console.log('SETUP - Model already loaded!')}"
      - takeScreenshot: 03-done-early

# ==============================
# Need to setup model
# ==============================
- runFlow:
    when:
      visible:
        id: "setup-card"
    commands:
      - evalScript: "${console.log('SETUP - Need to load model')}"
      - takeScreenshot: 04-setup-card

      # First, check if there are any downloaded models
      # Open Text picker to see if models exist
      - evalScript: "${console.log('SETUP - Check for existing models')}"
      - tapOn:
          text: "Text"
      - extendedWaitUntil:
          visible:
            text: "Text Models"
          timeout: 5000
      - takeScreenshot: 05-picker

      # Check if "No models" message is visible
      - runFlow:
          when:
            visible:
              text: "No text models downloaded"
          commands:
            # No models exist, need to download one
            - evalScript: "${console.log('SETUP - No models, need to download')}"
            - takeScreenshot: 06-no-models

            # Close picker by tapping outside or back
            - tapOn:
                point: "50%,10%"

            # Go to Models tab
            - evalScript: "${console.log('SETUP - Go to Models tab')}"
            - tapOn:
                id: "models-tab"

            - extendedWaitUntil:
                visible:
                  id: "models-screen"
                timeout: 10000
            - evalScript: "${console.log('SETUP - On models screen')}"
            - takeScreenshot: 07-models-screen

            - extendedWaitUntil:
                visible:
                  id: "models-list"
                timeout: 15000

            # Search for SmolLM2 135M
            - evalScript: "${console.log('SETUP - Searching')}"
            - tapOn:
                id: "search-input"
            - inputText: "SmolLM2-135M-Instruct-GGUF unsloth"
            - tapOn:
                id: "search-button"
            - takeScreenshot: 08-search
            # Wait for result
            - extendedWaitUntil:
                visible:
                  text: "SmolLM2-135M-Instruct-GGUF"
                timeout: 30000
            - evalScript: "${console.log('SETUP - Found model')}"
            - takeScreenshot: 09-found
            - tapOn:
                text: "SmolLM2-135M-Instruct-GGUF"

            - extendedWaitUntil:
                visible:
                  text: "Available Files"
                timeout: 15000
            - takeScreenshot: 10-files

            # Download the model
            - evalScript: "${console.log('SETUP - Downloading')}"
            - tapOn:
                text: "Download"
            - extendedWaitUntil:
                visible:
                  text: "Success"
                timeout: 300000
            - evalScript: "${console.log('SETUP - Downloaded!')}"
            - takeScreenshot: 11-success
            - tapOn:
                text: "OK"

            # Go back to home
            - evalScript: "${console.log('SETUP - Back to home')}"
            - tapOn:
                id: "home-tab"
            - extendedWaitUntil:
                visible:
                  id: "home-screen"
                timeout: 10000
            - takeScreenshot: 12-home

            # Open Text picker again
            - evalScript: "${console.log('SETUP - Open picker again')}"
            - tapOn:
                text: "Text"
            - extendedWaitUntil:
                visible:
                  text: "Text Models"
                timeout: 5000
            - takeScreenshot: 13-picker

      # At this point, picker is open and there should be at least one model
      # Select the first available model
      - evalScript: "${console.log('SETUP - Select first model')}"
      - tapOn:
          index: 0
          id: "model-item"
      - evalScript: "${console.log('SETUP - Model tapped')}"
      - takeScreenshot: 14-tapped

      # Handle low memory warning
      - runFlow:
          when:
            visible:
              text: "Load Anyway"
          commands:
            - evalScript: "${console.log('SETUP - Low memory, load anyway')}"
            - tapOn:
                text: "Load Anyway"

      # Wait for model to load
      - evalScript: "${console.log('SETUP - Waiting for load')}"
      - extendedWaitUntil:
          visible:
            id: "new-chat-button"
          timeout: 120000
      - evalScript: "${console.log('SETUP - Model loaded!')}"
      - takeScreenshot: 15-loaded

# ==============================
# Final verification
# ==============================
- assertVisible:
    id: "new-chat-button"
- evalScript: "${console.log('SETUP - PASSED')}"
- takeScreenshot: 99-complete