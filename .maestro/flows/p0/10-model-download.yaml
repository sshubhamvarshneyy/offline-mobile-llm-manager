# P0 E2E: Model Download
# Tests the full model download flow from search to completion
#
# Precondition: Clean app state (uses clearState)
# Test: Search for model → Download → Verify success
# Postcondition: Model downloaded and available

appId: com.localllm
name: "P0: Model Download"
tags:
  - p0
  - model-download
---

# ==============================
# Launch app
# ==============================
- clearState
- evalScript: "${console.log('DOWNLOAD - Launch')}"
- launchApp

- extendedWaitUntil:
    notVisible:
      id: "app-loading"
    timeout: 30000
- evalScript: "${console.log('DOWNLOAD - App ready')}"

# ==============================
# Skip onboarding
# ==============================
- runFlow:
    when:
      visible:
        text: "Welcome to Local LLM"
    commands:
      - evalScript: "${console.log('DOWNLOAD - Skip onboarding')}"
      - tapOn:
          text: "Skip"
      - extendedWaitUntil:
          visible:
            text: "Skip for Now"
          timeout: 30000
      - tapOn:
          text: "Skip for Now"

# Skip download prompt
- runFlow:
    when:
      visible:
        text: "Download Your First Model"
    commands:
      - evalScript: "${console.log('DOWNLOAD - Skip prompt')}"
      - tapOn:
          text: "Skip for Now"

# ==============================
# Wait for home screen
# ==============================
- extendedWaitUntil:
    visible:
      id: "home-screen"
    timeout: 15000
- evalScript: "${console.log('DOWNLOAD - On home')}"
- takeScreenshot: 01-home

# ==============================
# Navigate to Models tab
# ==============================
- evalScript: "${console.log('DOWNLOAD - Go to Models')}"
- tapOn:
    id: "models-tab"

- extendedWaitUntil:
    visible:
      id: "models-screen"
    timeout: 10000
- takeScreenshot: 02-models-screen

- extendedWaitUntil:
    visible:
      id: "models-list"
    timeout: 15000

# ==============================
# Search for SmolLM2 135M
# ==============================
- evalScript: "${console.log('DOWNLOAD - Search for model')}"
- tapOn:
    id: "search-input"
- inputText: "SmolLM2-135M-Instruct-GGUF unsloth"
- tapOn:
    id: "search-button"
- takeScreenshot: 03-search

# Wait for results
- extendedWaitUntil:
    visible:
      text: "SmolLM2-135M-Instruct-GGUF"
    timeout: 30000
- evalScript: "${console.log('DOWNLOAD - Found model')}"
- takeScreenshot: 04-found

# ==============================
# Open model details
# ==============================
- tapOn:
    text: "SmolLM2-135M-Instruct-GGUF"

- extendedWaitUntil:
    visible:
      text: "Available Files"
    timeout: 15000
- takeScreenshot: 05-files

# ==============================
# Download the model
# ==============================
- evalScript: "${console.log('DOWNLOAD - Start download')}"
- tapOn:
    text: "Download"

# Wait for download to complete (5 min timeout)
- extendedWaitUntil:
    visible:
      text: "Success"
    timeout: 300000
- evalScript: "${console.log('DOWNLOAD - Complete!')}"
- takeScreenshot: 06-success

# ==============================
# Verify and close
# ==============================
- assertVisible:
    text: "Success"
- tapOn:
    text: "OK"

- evalScript: "${console.log('DOWNLOAD - PASSED')}"
- takeScreenshot: 99-complete
