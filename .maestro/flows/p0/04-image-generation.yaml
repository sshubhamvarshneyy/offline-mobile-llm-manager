# P0 E2E: Image Generation Flow
# Tests the complete image generation cycle including model download
# This test ensures image model is downloaded and tests image generation

appId: ai.offgridmobile
name: "P0: Image Generation"
tags:
  - p0
  - generation
  - image
---

# ==============================
# Launch and setup
# ==============================
- evalScript: "${console.log('IMAGE_GEN - Launch')}"
- launchApp

- extendedWaitUntil:
    notVisible:
      id: "app-loading"
    timeout: 30000

# Handle onboarding
- runFlow:
    when:
      visible:
        text: "Welcome to Off Grid"
    commands:
      - evalScript: "${console.log('IMAGE_GEN - Skip onboarding')}"
      - tapOn:
          text: "Skip"
      - extendedWaitUntil:
          visible:
            text: "Skip for Now"
          timeout: 30000
      - tapOn:
          text: "Skip for Now"

# Handle download prompt
- runFlow:
    when:
      visible:
        text: "Download Your First Model"
    commands:
      - evalScript: "${console.log('IMAGE_GEN - Skip prompt')}"
      - tapOn:
          text: "Skip for Now"

# Wait for home screen
- extendedWaitUntil:
    visible:
      id: "home-screen"
    timeout: 15000
- evalScript: "${console.log('IMAGE_GEN - On home')}"

# Ensure text model is loaded
- runFlow:
    when:
      visible:
        id: "setup-card"
    commands:
      - evalScript: "${console.log('IMAGE_GEN - Load text model')}"
      - runFlow: 00-setup-model.yaml

# ==============================
# Ensure image model is active
# ==============================
# First check: Is image model already loaded on home screen?
- evalScript: "${console.log('IMAGE_GEN - Check image model status')}"

# Check if we need to select/download a model ("Tap to select" or "No models" visible)
- runFlow:
    when:
      visible:
        text: "Tap to select"
    commands:
      - evalScript: "${console.log('IMAGE_GEN - Model downloaded but not active, selecting...')}"
      - tapOn:
          id: "image-model-card"

      # Wait for picker to appear
      - extendedWaitUntil:
          visible:
            text: "Image Models"
          timeout: 5000

      # Select first model
      - tapOn:
          id: "model-item"
          index: 0

      # Wait for model to load
      - extendedWaitUntil:
          notVisible:
            text: "Tap to select"
          timeout: 30000

# If "No models" shown, need to download
- runFlow:
    when:
      visible:
        text: "No models"
    commands:
      - evalScript: "${console.log('IMAGE_GEN - No models, need to download')}"
      - tapOn:
          id: "image-model-card"

      # Wait for picker to appear
      - extendedWaitUntil:
          visible:
            text: "Image Models"
          timeout: 5000

      # If no models downloaded, go to Models screen
      - runFlow:
          when:
            visible:
              text: "No image models downloaded"
          commands:
            - evalScript: "${console.log('IMAGE_GEN - No models downloaded, need to download')}"

            # Close picker
            - tapOn:
                text: "Browse Models"

            # Wait for Models screen
            - extendedWaitUntil:
                visible:
                  id: "models-screen"
                timeout: 10000

            # Switch to Image Models tab
            - evalScript: "${console.log('IMAGE_GEN - Image Models tab')}"
            - tapOn:
                text: "Image Models"
            - takeScreenshot: 01-image-models-tab

            # Wait for models to load (no NPU filter, use CPU)
            - extendedWaitUntil:
                visible:
                  text: "Absolute Reality (CPU)"
                timeout: 5000

            # Tap download button (1st card = index 0)
            - evalScript: "${console.log('IMAGE_GEN - Downloading CPU model')}"
            - tapOn:
                text: "Download"
                index: 0

            # Wait for download to complete
            - evalScript: "${console.log('IMAGE_GEN - Waiting for download...')}"
            - extendedWaitUntil:
                visible:
                  text: "Success"
                timeout: 180000

            - evalScript: "${console.log('IMAGE_GEN - Download complete, auto-activated!')}"
            - takeScreenshot: 02-download-complete
            - tapOn:
                text: "OK"

            # Go back to home (model is auto-activated after download)
            - evalScript: "${console.log('IMAGE_GEN - Back to home')}"
            - tapOn:
                text: "Home"

            - extendedWaitUntil:
                visible:
                  id: "home-screen"
                timeout: 10000

# Ensure we're on home screen before continuing
- extendedWaitUntil:
    visible:
      id: "home-screen"
    timeout: 10000

# ==============================
# Test image generation
# ==============================
- evalScript: "${console.log('IMAGE_GEN - Start chat')}"
- tapOn:
    id: "new-chat-button"

- extendedWaitUntil:
    visible:
      id: "chat-screen"
    timeout: 10000

# ==============================
# Configure auto-detect settings
# ==============================
- evalScript: "${console.log('IMAGE_GEN - Configure settings')}"
- tapOn:
    id: "chat-settings-icon"

- extendedWaitUntil:
    visible:
      text: "Auto-detect image requests"
    timeout: 5000

# Tap on Auto mode
- evalScript: "${console.log('IMAGE_GEN - Set Auto mode')}"
- tapOn:
    id: "image-gen-mode-auto"

# Tap on Pattern
- evalScript: "${console.log('IMAGE_GEN - Set Pattern')}"
- tapOn:
    id: "auto-detect-method-pattern"

# Close settings modal
- evalScript: "${console.log('IMAGE_GEN - Close settings')}"
- tapOn:
    text: "Done"

# Type an image generation prompt
- evalScript: "${console.log('IMAGE_GEN - Type prompt')}"
- tapOn:
    id: "chat-input"
- inputText: "Draw a picture of a cute cat"

# Dismiss keyboard
- hideKeyboard

# Send the message
- evalScript: "${console.log('IMAGE_GEN - Send')}"
- tapOn:
    id: "send-button"

# Wait for image generation to complete (3 min timeout)
- evalScript: "${console.log('IMAGE_GEN - Wait for image')}"
- extendedWaitUntil:
    visible:
      id: "generated-image"
    timeout: 180000

- evalScript: "${console.log('IMAGE_GEN - Image generated!')}"
- takeScreenshot: 02-image-generated

# Verify image can be tapped
- tapOn:
    id: "generated-image"
- takeScreenshot: 03-image-viewer

# Close image viewer
- back

- evalScript: "${console.log('IMAGE_GEN - PASSED')}"
