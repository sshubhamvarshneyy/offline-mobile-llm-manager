# P0 E2E: Model Selection
# Tests selecting a model from multiple downloaded models
#
# Precondition: At least 2 models downloaded, none loaded
# Test: Open picker → Select model → Verify loaded
# Postcondition: Model loaded and ready

appId: com.localllm
name: "P0: Model Selection"
tags:
  - p0
  - model-selection
---

# ==============================
# Launch app
# ==============================
- evalScript: "${console.log('SELECTION - Launch')}"
- launchApp

- extendedWaitUntil:
    notVisible:
      id: "app-loading"
    timeout: 30000
- evalScript: "${console.log('SELECTION - App ready')}"

# ==============================
# Skip onboarding if needed
# ==============================
- runFlow:
    when:
      visible:
        text: "Welcome to Local LLM"
    commands:
      - evalScript: "${console.log('SELECTION - Skip onboarding')}"
      - tapOn:
          text: "Skip"
      - extendedWaitUntil:
          visible:
            text: "Skip for Now"
          timeout: 30000
      - tapOn:
          text: "Skip for Now"

- runFlow:
    when:
      visible:
        text: "Download Your First Model"
    commands:
      - evalScript: "${console.log('SELECTION - Skip prompt')}"
      - tapOn:
          text: "Skip for Now"

# ==============================
# Wait for home screen
# ==============================
- extendedWaitUntil:
    visible:
      id: "home-screen"
    timeout: 15000
- evalScript: "${console.log('SELECTION - On home')}"
- takeScreenshot: 01-home

# ==============================
# Ensure we have at least 2 models
# ==============================
# If no models, download 2
# If 1 model, download 1 more
# This ensures we can test selection between multiple models

- runFlow:
    when:
      visible:
        id: "setup-card"
    commands:
      # No models loaded, check if any downloaded
      - evalScript: "${console.log('SELECTION - Check models')}"
      - tapOn:
          text: "Text"
      - extendedWaitUntil:
          visible:
            text: "Text Models"
          timeout: 5000

      # If no models exist, download one via setup
      - runFlow:
          when:
            visible:
              text: "No text models downloaded"
          commands:
            - evalScript: "${console.log('SELECTION - Need to download model')}"
            - tapOn:
                point: "50%,10%"
            # Run setup to get a model
            - runFlow: 00-setup-model.yaml

      # Close picker
      - evalScript: "${console.log('SELECTION - Close picker')}"
      - tapOn:
          point: "50%,10%"

# ==============================
# Unload any currently loaded model
# ==============================
- evalScript: "${console.log('SELECTION - Ensure no model loaded')}"
- tapOn:
    text: "Home"
- extendedWaitUntil:
    visible:
      id: "home-screen"
    timeout: 10000

- runFlow:
    when:
      visible:
        id: "new-chat-button"
    commands:
      # Model is loaded, unload it
      - evalScript: "${console.log('SELECTION - Unload current model')}"
      - tapOn:
          text: "Text"
      - extendedWaitUntil:
          visible:
            text: "Text Models"
          timeout: 5000
      - tapOn:
          text: "Unload current model"
      - extendedWaitUntil:
          visible:
            id: "setup-card"
          timeout: 10000

- takeScreenshot: 02-ready-to-select

# ==============================
# Test: Select a model
# ==============================
- evalScript: "${console.log('SELECTION - Open picker')}"
- tapOn:
    text: "Text"

- extendedWaitUntil:
    visible:
      text: "Text Models"
    timeout: 5000
- takeScreenshot: 03-picker

# Select first model in list
- evalScript: "${console.log('SELECTION - Select model')}"
- tapOn:
    index: 0
    id: "model-item"
- takeScreenshot: 04-selected

# Handle low memory warning
- runFlow:
    when:
      visible:
        text: "Load Anyway"
    commands:
      - evalScript: "${console.log('SELECTION - Load anyway')}"
      - tapOn:
          text: "Load Anyway"

# ==============================
# Verify model loaded
# ==============================
- evalScript: "${console.log('SELECTION - Waiting for load')}"
- extendedWaitUntil:
    visible:
      id: "new-chat-button"
    timeout: 120000

- assertVisible:
    id: "new-chat-button"
- evalScript: "${console.log('SELECTION - PASSED')}"
- takeScreenshot: 99-complete
