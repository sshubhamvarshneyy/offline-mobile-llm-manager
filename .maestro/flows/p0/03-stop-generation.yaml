# P0 E2E: Stop Generation Flow
# Tests stopping an in-progress generation
# Prerequisites: Text model must be loaded

appId: ai.offgridmobile
name: "P0: Stop Generation"
tags:
  - p0
  - generation
  - stop
---

- launchApp

# Wait for app initialization
- extendedWaitUntil:
    notVisible:
      id: "app-loading"
    timeout: 30000

# Handle onboarding if shown
- runFlow:
    when:
      visible:
        text: "Welcome to Off Grid"
    commands:
      - tapOn:
          text: "Skip"
      - extendedWaitUntil:
          visible:
            text: "Skip for Now"
          timeout: 30000
      - tapOn:
          text: "Skip for Now"

# Handle download prompt if shown
- runFlow:
    when:
      visible:
        text: "Download Your First Model"
    commands:
      - tapOn:
          text: "Skip for Now"

# Wait for home screen
- extendedWaitUntil:
    visible:
      id: "home-screen"
    timeout: 15000

# Ensure model is loaded (run setup if needed)
- runFlow:
    when:
      visible:
        id: "setup-card"
    commands:
      - runFlow: 00-setup-model.yaml

# Wait for new-chat-button (model must be loaded)
- extendedWaitUntil:
    visible:
      id: "new-chat-button"
    timeout: 5000

# Navigate to chat screen
- tapOn:
    id: "new-chat-button"

- extendedWaitUntil:
    visible:
      id: "chat-screen"
    timeout: 10000

# Type a message that will generate a VERY long response
- tapOn:
    id: "chat-input"
- inputText: "Write a comprehensive 2000 word essay covering the complete history of artificial intelligence from the 1950s to today, including all major milestones, breakthroughs, key researchers, important papers, and technological developments in extreme detail"

# Dismiss keyboard before tapping send
- hideKeyboard

# Send the message
- tapOn:
    id: "send-button"

# Wait for stop button to appear (generation started)
- extendedWaitUntil:
    visible:
      id: "stop-button"
    timeout: 5000

# Tap stop immediately (small model generates fast)
- tapOn:
    id: "stop-button"

# Verify stop button disappears
- extendedWaitUntil:
    notVisible:
      id: "stop-button"
    timeout: 10000

# Dismiss voice input dialog if it appeared
- runFlow:
    when:
      visible:
        text: "Voice Input Unavailable"
    commands:
      - tapOn:
          text: "OK"

# Verify input is ready
- assertVisible:
    id: "chat-input"
