# P0 E2E: Image Model Set Active
# Tests selecting a downloaded image model from the home screen picker
# Assumes an image model is already downloaded but not active

appId: ai.offgridmobile
name: "P0: Image Model Set Active"
tags:
  - p0
  - models
  - image
---

# ==============================
# Launch and setup
# ==============================
- evalScript: "${console.log('IMG_SET_ACTIVE - Launch')}"
- launchApp

- extendedWaitUntil:
    notVisible:
      id: "app-loading"
    timeout: 30000

# Handle onboarding
- runFlow:
    when:
      visible:
        text: "Welcome to Off Grid"
    commands:
      - evalScript: "${console.log('IMG_SET_ACTIVE - Skip onboarding')}"
      - tapOn:
          text: "Skip"
      - extendedWaitUntil:
          visible:
            text: "Skip for Now"
          timeout: 30000
      - tapOn:
          text: "Skip for Now"

# Handle download prompt
- runFlow:
    when:
      visible:
        text: "Download Your First Model"
    commands:
      - evalScript: "${console.log('IMG_SET_ACTIVE - Skip prompt')}"
      - tapOn:
          text: "Skip for Now"

# Wait for home screen
- extendedWaitUntil:
    visible:
      id: "home-screen"
    timeout: 15000
- evalScript: "${console.log('IMG_SET_ACTIVE - On home')}"

# ==============================
# Ensure model is unloaded first
# ==============================
# If a model is already loaded (not showing "Tap to select"), unload it
- runFlow:
    when:
      notVisible:
        text: "Tap to select"
    commands:
      - evalScript: "${console.log('IMG_SET_ACTIVE - Model already loaded, unloading...')}"
      - tapOn:
          id: "image-model-card"

      # Wait for picker
      - extendedWaitUntil:
          visible:
            text: "Image Models"
          timeout: 5000

      # Tap "Unload current model"
      - tapOn:
          text: "Unload current model"

      # Wait for model to unload
      - extendedWaitUntil:
          visible:
            text: "Tap to select"
          timeout: 30000

# ==============================
# Select image model
# ==============================
- evalScript: "${console.log('IMG_SET_ACTIVE - Verify Tap to select shown')}"
- extendedWaitUntil:
    visible:
      text: "Tap to select"
    timeout: 5000

# Tap on Image card to open picker
- evalScript: "${console.log('IMG_SET_ACTIVE - Open picker')}"
- tapOn:
    id: "image-model-card"

# Wait for picker to appear
- extendedWaitUntil:
    visible:
      text: "Image Models"
    timeout: 5000

# Select first model
- evalScript: "${console.log('IMG_SET_ACTIVE - Select model')}"
- tapOn:
    id: "model-item"
    index: 0

# Wait for model to load
- evalScript: "${console.log('IMG_SET_ACTIVE - Waiting for model to load...')}"
- extendedWaitUntil:
    notVisible:
      text: "Tap to select"
    timeout: 30000

# Verify model name is shown (don't check exact name as it could be any model)
- evalScript: "${console.log('IMG_SET_ACTIVE - Model loaded successfully')}"

- evalScript: "${console.log('IMG_SET_ACTIVE - PASSED')}"
